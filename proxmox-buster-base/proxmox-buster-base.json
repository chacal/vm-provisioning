{
  "variables": {
    "proxmox_password": "{{env `PM_PASS`}}"
  },
  "builders": [
    {
      "type": "proxmox",
      "proxmox_url": "{{user `proxmox_url`}}",
      "insecure_skip_tls_verify": true,
      "username": "{{user `proxmox_user`}}",
      "password": "{{user `proxmox_password`}}",
      "node": "{{user `proxmox_node`}}",
      "vm_name": "buster-base",
      "memory": 2048,
      "cores": 2,
      "cpu_type": "host",
      "scsi_controller": "virtio-scsi-pci",
      "os": "l26",
      "network_adapters": [
        {
          "bridge": "vmbr0",
          "model": "virtio"
        }
      ],
      "disks": [
        {
          "type": "scsi",
          "disk_size": "5G",
          "cache_mode": "writeback",
          "storage_pool": "local-zfs",
          "storage_pool_type": "zfspool",
          "format": "raw"
        }
      ],
      "boot_command": [
        "<esc><wait>",
        "auto url=http://{{ .HTTPIP }}:{{ .HTTPPort }}/preseed.cfg<enter>"
      ],
      "iso_file": "local:iso/debian-10.3.0-amd64-netinst.iso",
      "iso_checksum": "6a901b5abe43d88b39d627e1339d15507cc38f980036b928f835e0f0e957d3d8",
      "iso_storage_pool": "local",
      "http_directory": "{{ template_dir }}",
      "boot_wait": "10s",
      "ssh_username": "jihartik",
      "ssh_timeout": "15m",
      "ssh_private_key_file": "~/.ssh/id_rsa",
      "unmount_iso": true,
      "template_name": "buster-base-template-{{ isotime \"2006-01-02\" }}",
      "template_description": "Debian 10 custom base image, {{ isotime \"2006-01-02\" }}"
    }
  ],
  "provisioners": [
    {
      "type": "ansible",
      "playbook_file": "{{user `ansible_provisioning_dir`}}/proxmox-buster-base.yml",
      "ansible_env_vars": [
        "ANSIBLE_HOST_KEY_CHECKING=False",
        "ANSIBLE_VAULT_PASSWORD_FILE=~/.ansible_vault_pass.txt",
        "ANSIBLE_ROLES_PATH={{user `ansible_roles_dir`}}"
      ]
    }
  ],
  "post-processors": [
    {
      "type": "manifest"
    },
    {
      "type": "shell-local",
      "inline": [
        "VM_ID=$(jq -r '.builds[-1].artifact_id' packer-manifest.json | cut -d \":\" -f2)",
        "ssh root@fujari.chacal.fi qm set ${VM_ID} --ide0 local-zfs:cloudinit",
        "rm packer-manifest.json"
      ]
    }
  ]
}